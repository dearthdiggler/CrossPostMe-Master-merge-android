name: CI
permissions:
  contents: read
  issues: read
  pull-requests: read

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  backend:
    name: Backend checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # trunk-ignore(actionlint/action)
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up Node.js (for migrate-mongo)
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install migrate-mongo
        run: |
          npm install -g migrate-mongo

      - name: Run DB migrations (migrate-mongo)
        run: |
          if [ -f migrate-mongo-config.js ]; then
            migrate-mongo up
          else
            echo "No migrate-mongo-config.js found, skipping migrations."
          fi

      - name: Install backend requirements
        run: |
          python -m venv .venv
          . .venv/bin/activate
          python -m pip install --upgrade pip
          pip install -r app/backend/requirements.txt

      - name: Run mypy
        run: |
          . .venv/bin/activate
          mypy app/backend --config-file mypy.ini

      - name: Run pytest (if tests exist)
        run: |
          . .venv/bin/activate
          if [ -d app/backend/tests ]; then
            pytest -q app/backend/tests
          elif [ -d app/tests ]; then
            pytest -q app/tests
          else
            echo "No Python tests found"
          fi

      - name: Notify Slack on failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,message,commit,author,workflow,job,ref,elapsed
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Slack on success
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,message,commit,author,workflow,job,ref,elapsed
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  frontend:
    name: Frontend checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: yarn

      - name: Install frontend dependencies
        run: yarn install
        working-directory: app/frontend

      - name: Run frontend tests
        run: |
          yarn test --ci --silent
        working-directory: app/frontend
        env:
          CI: true

      - name: Run Playwright tests
        run: |
          yarn add @playwright/test
          npx playwright install
          npx playwright test playwright-tests
        working-directory: app/frontend
        env:
          CI: true

      - name: Notify Slack on failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,message,commit,author,workflow,job,ref,elapsed
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Slack on success
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,message,commit,author,workflow,job,ref,elapsed
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
